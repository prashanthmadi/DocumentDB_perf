# MongoDB Schema Migration Tool

Extract schema from a source MongoDB server and apply it to a destination MongoDB/DocumentDB server.

## Overview

This tool connects directly to a live MongoDB server to extract complete schema information (databases, collections, indexes, shard keys) and then applies that schema to a destination server. This is useful for:
- Migrating from MongoDB Atlas to Azure Cosmos DB (DocumentDB API)
- Cloning schema between MongoDB environments
- Setting up test/dev environments with production schema structure

## Features

- ‚úÖ Extracts complete schema from source MongoDB/Atlas
- ‚úÖ Captures indexes (including unique, sparse, TTL)
- ‚úÖ Detects sharded collections and shard keys
- ‚úÖ Applies schema to destination MongoDB/DocumentDB
- ‚úÖ Supports both `mongosh` (MongoDB 4.2+) and legacy `mongo` CLI (MongoDB 3.6)
- ‚úÖ Optional database name prefix for destination
- ‚úÖ Detailed progress reporting and error handling

## Files

| File | Description |
|------|-------------|
| `extract_schema.py` | Extracts schema from source MongoDB server |
| `apply_schema.py` | Applies extracted schema to destination server |
| `schema.json` | Schema file (generated by extract_schema.py) |
| `.env` | Configuration file with connection strings |

## Prerequisites

**MongoDB CLI:**
- For MongoDB 4.2+: Install `mongosh` - https://www.mongodb.com/try/download/shell
- For MongoDB 3.6: Use legacy `mongo` CLI (included with MongoDB installation)

**Python:**
- Python 3.7+
- Install dependencies: `pip install python-dotenv`

## Quick Start

### 1. Configure Connections

Create a `.env` file:

```bash
# Source MongoDB connection (where to extract schema from)
SOURCE_MONGODB_CONNECTION_STRING=mongodb://username:password@source-server:27017/?authSource=admin

# Destination MongoDB/DocumentDB connection (where to apply schema)
DEST_MONGODB_CONNECTION_STRING=mongodb://username:password@dest-server.mongocluster.cosmos.azure.com:27017/?tls=true&authSource=admin

# Optional: Add prefix to database names in destination
DATABASE_PREFIX=

# Connection timeout in seconds
TIMEOUT_SECONDS=120
```

### 2. Extract Schema from Source

```bash
python extract_schema.py --output schema.json
```

**For MongoDB 3.6 servers (if you get wire version error):**
```bash
python extract_schema.py --output schema.json --use-legacy-cli
```

This will:
- Connect to your source MongoDB server
- Extract all databases, collections, indexes, and shard keys
- Save to `schema.json`

### 3. Review Schema (Optional)

Open `schema.json` and remove any databases or collections you don't want to migrate:

```json
{
  "extracted_at": "2024-02-06T10:30:00Z",
  "databases": [
    {
      "database": "myapp",
      "size_gb": 2.5,
      "collections": [
        {
          "name": "users",
          "doc_count": 10000,
          "size_gb": 0.5,
          "indexes": [
            {
              "name": "_id_",
              "keys": {"_id": 1},
              "unique": false
            },
            {
              "name": "email_1",
              "keys": {"email": 1},
              "unique": true,
              "sparse": false
            }
          ],
          "is_sharded": false,
          "shard_key": null
        }
      ]
    }
  ]
}
```

### 4. Apply Schema to Destination

```bash
python apply_schema.py --schema schema.json
```

This will:
- Connect to your destination server
- Create all databases and collections
- Create all indexes
- Handle sharded collections (if supported)
- Report detailed progress

## Configuration Options

### Database Prefix

Add a prefix to all database names in the destination. Set in `.env`:

```bash
DATABASE_PREFIX=prod_
```

This creates `prod_myapp`, `prod_analytics`, etc.

### MongoDB CLI Selection

The tool auto-detects the available MongoDB CLI:
- Tries `mongosh` first (for MongoDB 4.2+)
- Falls back to legacy `mongo` (for MongoDB 3.6)

**Force legacy CLI:**
```bash
python extract_schema.py --use-legacy-cli
```

## Example Output

**Extracting Schema:**
```
============================================================
MongoDB Schema Extraction Tool
============================================================

üîç Checking for MongoDB CLI...
   ‚úì Found mongosh: 2.0.0

üìù Connection string loaded: mongodb://***@source-server:27017/...

üöÄ Executing command...
‚è≥ Connecting to MongoDB server...

‚úì Connection successful
üîç Parsing JSON output...
‚úì JSON parsed successfully

‚úÖ Schema extracted and saved to: schema.json

üìä Summary:
   Databases: 3
   Collections: 15
   Indexes: 42
   Sharded Collections: 2

   üìÅ myapp (2.500 GB)
      Collections: 8
         - users (10,000 docs, 5 indexes)
         - orders (50,000 docs, 8 indexes) [SHARDED: {"customer_id": 1}]

üí° Next step:
   1. Review/edit schema.json to remove unwanted databases/collections
   2. Run: python apply_schema.py --schema schema.json
```

**Applying Schema:**
```
============================================================
Applying Schema to Destination MongoDB
============================================================
Total Databases: 3
Database Prefix: None
============================================================

üìÅ Database: myapp
   üìÑ Creating collection: users
      ‚úÖ Collection created
   // Creating 5 indexes
      ‚úÖ Index: email_1
      ‚úÖ Index: created_at_1
      ...

============================================================
Schema Application Complete
============================================================
Databases Created: 3
Collections Created: 15
Indexes Created: 42
============================================================
```

## Troubleshooting

### Wire Version Incompatibility

**Error:** `wire version ... requires at least 13`

**Solution:** Your server is MongoDB 3.6 (or earlier), but `mongosh` requires 4.2+:
```bash
python extract_schema.py --use-legacy-cli
```

### Connection Errors

**DNS Resolution Error:**
- Verify hostname in connection string
- Check network connectivity

**Connection Refused:**
- Verify server is running
- Check port number and firewall rules

**Authentication Failed:**
- Verify username/password
- Check `authSource` parameter

**Timeout:**
- Increase `TIMEOUT_SECONDS` in `.env`
- Check network connectivity

### Missing MongoDB CLI

**Error:** `No MongoDB CLI found`

**Solution:**
- Install `mongosh`: https://www.mongodb.com/try/download/shell
- Or install MongoDB (includes legacy `mongo` CLI)

## Next Steps

After creating the schema:

1. **Migrate Data:**
   - Use `mongodump`/`mongorestore`
   - Azure Data Factory
   - Custom data migration scripts

2. **Verify Migration:**
   - Compare document counts
   - Test critical queries
   - Validate indexes are created

3. **Performance Testing:**
   - Run query performance tests
   - Monitor index usage
   - Optimize as needed

## Notes

- This tool only migrates **schema structure** (collections and indexes)
- **Data migration** requires separate tools
- Sharding support depends on destination server capabilities
- Azure Cosmos DB (DocumentDB API) has limited sharding support
- Always test in a non-production environment first
